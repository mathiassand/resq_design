---
title: "anon_data_RESQ"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(tibble)
library(skimr)
library(magrittr)
library(purrr)
library(ggtext)
library(grid)
library(ggrepel)
library(directlabels)
library(reshape2)

```

```{r loadingData, echo=FALSE}

resq_anon <- read_csv("anon_data_Hendrik.csv")

resq_clean <- na.omit(resq_anon)

resq_mean<-resq_clean %>%
  group_by(hospital, year) %>%
  summarise(DTNMean = mean(DTN)) %>% 
  ungroup()

resq_df<-resq_clean %>%
  #filtering for years after 2015 only, as Mirek told us RES-Q was added in 2016. 
  #Dataset has a lot of misstypes, or errors? 1900, 2013, 2014 etc.
  filter(year > 2015) %>%
  group_by(hospital) %>%
  summarise(
    firstYear=min(year),
    latestYear=max(year),
    noOfYears=n_distinct(year)
    ) %>% 
  ungroup()

join_df <- merge(resq_df, resq_mean, by="hospital") %>% mutate(runningYear=year-firstYear+1)
  
  
  # group_by(hospital) %>%
  # mutate(firstYear=min(year),
  #        lastYear=max(year)
  #        ) %>% 
  # ungroup()

#if starting year = ending year, then we probably shouldn't plot, since they don't have progress?

#cohorts need to be changed to their beginning DTNMean instead, as this will show us
#where they started, showing us their "story".
DTN_breaks <- c(-Inf, 30, 45, 60, 120, Inf)
DTN_break_labels <- c("<30", "30-45", "45-60", "60-120", ">120")

cohort_df<-join_df %>%
  ungroup() %>%
  group_by(runningYear) %>%
  mutate(
    DTNMeanCohort = cut(DTNMean, breaks = DTN_breaks, labels = DTN_break_labels)
     ) %>% 
  ungroup()


cohort_df <- cohort_df %>% 
  filter(runningYear==1) %>%
  select(hospital,DTNMeanCohort) %>% 
  rename(startingDTNMeanCohort=DTNMeanCohort) %>%
  merge(cohort_df)


# %>% group_by(DTNMeanCohort) %>% summarise(CohortCount=n())
  

rsqh <- cohort_df %>%
  filter(hospital == "Hospital #103")




```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
cohort_df %>%
  ungroup() %>%
  filter(DTNMean < 200 & year >= 2016 & noOfYears>3) %>%
  ggplot(aes(x = jitter(runningYear,amount=0.1),colour=startingDTNMeanCohort, y = DTNMean)) +
  geom_point() +
  geom_smooth(se=TRUE,alpha=.5) +
  theme_bw() +
  coord_cartesian(ylim=c(0, 200))+scale_x_continuous(breaks=seq(1,6,1))

cohort_df %>%
     ungroup() %>%
     filter(DTNMean < 200 & year >= 2016 & year < 2021 & noOfYears>3) %>%
     ggplot(aes(x = jitter(runningYear,amount=0.1),colour=startingDTNMeanCohort, y = DTNMean)) +
     geom_point() +
     geom_smooth(se=TRUE,alpha=.5) +
     theme_bw() +
     coord_cartesian(ylim=c(0, 200))+scale_x_continuous(breaks=seq(1,6,1))


ggplot(rsqh[rsqh$DTNMedian<250 & rsqh$DTNMean < 200 & rsqh$year>=2016,], aes(x = year, y = DTNMean)) + 
  geom_line(aes(color = factor(hospital)), show.legend = FALSE) + 
  theme_bw() + 
  scale_color_grey(start = 0.5, end=0.5)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
